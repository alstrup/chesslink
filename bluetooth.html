<html>

<script>

function getParity(n) {
    var parity = 0; 
    while (n != 0) { 
        parity = 1 - parity; 
        n = n & (n - 1); 
    }      
    return parity; 
}

function addOddParity(n) {
	n = n & 0x7f;
	if (getParity(n) == 1) {
		return n | 0x80
	} else return n;
}

function checksum(s) {
	var par = 0x00;
	for (var i = 0; i < s.length; ++i) {
		par = par ^ s.charCodeAt(i);
	}
	return par.toString(16);
}

// This encodes the message s with parity and checksum for transmission
function encode(s) {
	var msg = s + checksum(s);
	var res = [];
	for (var i = 0; i < msg.length; ++i) {
		res.push(addOddParity(msg.charCodeAt(i)));
	}
	return res;
}

function monitorCharacteristic(name, characteristic) {
	console.log("Got " + name + " characteristic with these properties:");
	console.log(characteristic.properties);

	characteristic.addEventListener('characteristicvaluechanged', event => {
		console.log(name + " Characteristic Changed");
		console.log(event)
	});
	characteristic.addEventListener('advertisementreceived', event => {
		console.log(name + " Advertisement Received");
		console.log(event)
	});

	// This does not give any useful information on the face of it:
/*	characteristic.getDescriptors().then(de => {
		console.log("Descriptors for " + name);
		for (var i = 0; i < de.length; ++i) {
			console.log(de[i]);
			de[i].readValue().then(val => {
				console.log("Description " + i + " value for " + name);
				console.log(val);
			}).catch(function(error) {
				console.log("Something went wrong with descriptor value. " + error);
			});
		}
	}).catch(function(error) {
		console.log("Something went wrong with descriptors. " + error);
	});*/
}

function read(name, characteristic) {
	characteristic.readValue().then(val => {
		console.log("Read from " + name);
		console.log(val);
	}).catch(e => {
		console.log("Could not read from " + name + ": " + e);
	});
}


function send(m) {
	console.log("Sending " + m);
	var message = encode(m);
	const buffer = new ArrayBuffer(message.length);
	var data = new Int8Array(buffer);
	for (var i = 0; i < message.length; ++i) {
		data[i] = message[i];
	}
	writeCharacteristic.writeValue(data).then(val => {
		console.log("Sent " + m + ".");
	}).catch(e => {
		console.log("Could not send " + m + ": " + e);
	});
}

var device = null;
var service = null;
var notifyCharacteristic = null;
var writeCharacteristic = null;
var readCharacteristic = null;


// This is what we run when we click
function discover() {
	let options = {
		filters: [{name: 'MILLENNIUM CHESS'}],
		optionalServices: ['49535343-fe7d-4ae5-8fa9-9fafd205e455']
	}

	navigator.bluetooth.requestDevice(options).then(function(d) {
		device = d;
		console.log('Found ' + device.name + " with id " + device.id);
		// Do something with the device.
		return device.gatt.connect();
	}).then(server => {
		console.log("Got connection");
		return device.gatt.getPrimaryService('49535343-fe7d-4ae5-8fa9-9fafd205e455');
	}).then(s => {
		service = s;
		console.log("Got service");
		console.log(s);
		// Find the notify characteristics
		return service.getCharacteristic("49535343-1e4d-4bd9-ba61-23c647249616");
	}).then(wc => {
		notifyCharacteristic = wc;
		monitorCharacteristic("notify", notifyCharacteristic);

		// This is what mchess does initially:
		const data = new Uint8Array([1]);
		return notifyCharacteristic.writeValue(data);
	}).then(__ => {
		console.log("1 written to notify characteristic");
		// Find the write characteristics
		return service.getCharacteristic("49535343-8841-43f4-a8d4-ecbe34729bb3");
	}).then(characteristic => {
		writeCharacteristic = characteristic;
		monitorCharacteristic("write", writeCharacteristic);
		// Find the read characteristics
		return service.getCharacteristic("49535343-6daa-4d02-abf6-19569aca69fe");
	}).then(characteristic => {
		readCharacteristic = characteristic;
		monitorCharacteristic("read", readCharacteristic);
	}).catch(function(error) {
		console.log("Something went wrong. " + error);
	});
}

function readall() {
	read("read", readCharacteristic);
	read("notify", notifyCharacteristic);
}

function sends() {
	send("S")
}

</script>

<button onclick="js:discover()">Connect</button>

<button onclick="js:readall()">Read all values</button>

<button onclick="js:sends()">Send S</button>

<ol>
	<li>
	Turn on your chess link, connect it with your laptop/computer/phone using bluetooth in the OS.
	</li>
	<li>
	Open the JS console to inspect connection and progress. Ctrl+shift+j in Chrome.
	</li>
	<li>
	Click Connect. It will scan for bluetooth devices, and your Millenium
	Chess device should appear. Pair with that, and you will get output
	about a connection, a service, and three different characteristics in the console.
	</li>
	<li>
	TODO: Figure out how to initialize the board state, & get moves.
	</li>
</ol>

</html>
